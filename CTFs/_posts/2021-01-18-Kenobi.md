---
title: Kenobi
author: Dimitrios Tsarouchas
date: 2021-01-18 20:55:00 +0800
categories: [CTFs, TryHackMe]
tags: [ctf, tryhackme]
pin: true
---


## Introduction
We are going to exploit a Linux machine called Kenobi. We will enumerate a shares service called Samba and try to get initial access on the machine by manipulating a vulnerable version of ProFTPD. Once we get the inital foothold on Kenobi we will we will escalate our privileges to root via an SUID binary by manipulating the path variable.

#### What is Samba?

![Samba](https://i.imgur.com/O8S93Kr.png)

Samba is the standard Windows interoperability suite of programs for Linux and Unix ([samba.org](https://www.samba.org/samba/what_is_samba.html){:target="_blank"}). Samba allows end users to access and use files, printers and other commonly shared resources on a corporate network or the Internet. Its often referred to as a network file system.

Samba is based on the common client/server protocol of Server Message Block (SMB). SMB is developed only for Windows, without Samba, other computer platforms would be isolated from Windows machines, even if they were part of the same network.

SMB has two ports, 445 and 139.

![SMB-Ports](https://i.imgur.com/bkgVNy3.png)

## Enumerating Kenobi

First step is to enumerate the target machine using nmap scan to check the number of open ports.

```terminal
root@kali:~# sudo nmap -T4 -A -p- 10.10.141.147

PORT      STATE SERVICE     VERSION
21/tcp    open  ftp         ProFTPD 1.3.5
22/tcp    open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 b3:ad:83:41:49:e9:5d:16:8d:3b:0f:05:7b:e2:c0:ae (RSA)
|   256 f8:27:7d:64:29:97:e6:f8:65:54:65:22:f7:c8:1d:8a (ECDSA)
|_  256 5a:06:ed:eb:b6:56:7e:4c:01:dd:ea:bc:ba:fa:33:79 (ED25519)
80/tcp    open  http        Apache httpd 2.4.18 ((Ubuntu))
| http-robots.txt: 1 disallowed entry 
|_/admin.html
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
111/tcp   open  rpcbind     2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  2,3,4       2049/tcp   nfs
|   100003  2,3,4       2049/tcp6  nfs
|   100003  2,3,4       2049/udp   nfs
|   100003  2,3,4       2049/udp6  nfs
|   100005  1,2,3      34833/tcp6  mountd
|   100005  1,2,3      54131/udp6  mountd
|   100005  1,2,3      57546/udp   mountd
|   100005  1,2,3      60079/tcp   mountd
|   100021  1,3,4      41713/tcp   nlockmgr
|   100021  1,3,4      45187/tcp6  nlockmgr
|   100021  1,3,4      53077/udp   nlockmgr
|   100021  1,3,4      58336/udp6  nlockmgr
|   100227  2,3         2049/tcp   nfs_acl
|   100227  2,3         2049/tcp6  nfs_acl
|   100227  2,3         2049/udp   nfs_acl
|_  100227  2,3         2049/udp6  nfs_acl
139/tcp   open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp   open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
2049/tcp  open  nfs_acl     2-3 (RPC #100227)
36673/tcp open  mountd      1-3 (RPC #100005)
36841/tcp open  mountd      1-3 (RPC #100005)
41713/tcp open  nlockmgr    1-4 (RPC #100021)
60079/tcp open  mountd      1-3 (RPC #100005)

Network Distance: 1 hop
Service Info: Host: KENOBI; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: 1h59m59s, deviation: 3h27m51s, median: -1s
|_nbstat: NetBIOS name: KENOBI, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: kenobi
|   NetBIOS computer name: KENOBI\x00
|   Domain name: \x00
|   FQDN: kenobi
|_  System time: 2021-01-11T12:32:36-06:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-01-11T18:32:36
|_  start_date: N/A
```

### Enumerating Samba for shares

We found through the nmap scan that on the target machine the ports 139 and 445 are open and running a Samba service. Nmap comes again in handy, this time we will enumerate the machine for SMB shares using two NSE scripts against the port 445.

    1. smb-enum-shares.nse
    2. smb-enum-users.nse

#### Running nmap using the NSE scripts
```terminal
root@kali:~# sudo nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse 10.10.141.147

PORT    STATE SERVICE
445/tcp open  microsoft-ds
MAC Address: 02:E7:9C:64:05:95 (Unknown)

Host script results:
| smb-enum-shares: 
|   account_used: guest
|   \\10.10.141.147\IPC$: 
|     Type: STYPE_IPC_HIDDEN
|     Comment: IPC Service (kenobi server (Samba, Ubuntu))
|     Users: 1
|     Max Users: <unlimited>
|     Path: C:\tmp
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\10.10.141.147\anonymous: 
|     Type: STYPE_DISKTREE
|     Comment: 
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\home\kenobi\share
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\10.10.141.147\print$: 
|     Type: STYPE_DISKTREE
|     Comment: Printer Drivers
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\var\lib\samba\printers
|     Anonymous access: <none>
|_    Current user access: <none>
|_smb-enum-users: ERROR: Script execution failed (use -d to debug)
```

We can see there are three shares in the machine and from those three we are interested in the anonymous share where we can login without using user credentials. We will use the `smbclient` to connect to the anonymous share. Smbclient is installed in most Linux distributions and it can also be downloaded from [github](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbclient.py){:target="_blank"} 

### Accessing the anonymous share
```terminal
root@kali:~# sudo smbclient //10.10.141.147/anonymous
Enter WORKGROUP\root's password: 
Try "help" to get a list of possible commands.
smb: \> help
```
